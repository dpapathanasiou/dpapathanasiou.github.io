<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=" | The personal web site of Denis Papathanasiou">
    <meta name="author" content="Denis Papathanasiou">
    <title>Creating and Sending Emails with File Attachments in Python</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link href="../css/my-blog.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

  <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>
  <nav id="sidebar-wrapper">
    <ul class="sidebar-nav">
      <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
      <li class="sidebar-brand"><a href="../" onclick="$('#menu-close').click();" >Denis Papathanasiou</a></li>
      <li class="sidebar-brand"><a href="../aikido.html" onclick="$('#menu-close').click();" >aikido</a></li>
      <li class="sidebar-brand"><a href="../hardware.html" onclick="$('#menu-close').click();" >hardware</a></li>
      <li class="sidebar-brand"><a href="../programming.html" onclick="$('#menu-close').click();" >programming</a></li>
      <li class="sidebar-brand"><a href="../random.html" onclick="$('#menu-close').click();" >random</a></li>
      <li class="sidebar-brand"><a href="../technology.html" onclick="$('#menu-close').click();" >technology</a></li>
      <li class="sidebar-brand"><a href="../#contacts" onclick="$('#menu-close').click();" >contact</a></li>
    </ul>
  </nav>


  <header class="intro-header" style="background-image: url('/img/source-code-bg.jpg')"> <!-- source: https://pixabay.com/en/source-code-code-programming-c-583537/ -->
    <div class="container">
      <div class="row">
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <div class="site-heading" style="color:#00ff00">
	    <h1>Creating and Sending Emails with File Attachments in Python</h1>
	    <hr class="small">
	    <h2 class="subheading"></h2>
	    <p class="post-meta"><i class="fa fa-calendar"></i> September 04, 2010</p>

	  </div>
	</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<a href="http://snippets.dzone.com/posts/show/757" target="_blank">This</a> is a good example of how to create and send emails with file attachments in Python.

It assumes, however, that every attached file is binary, and uses a generic <tt>application/octet-stream</tt> mimetype for each.

It also makes encoding assumptions about the strings passed to the Subject line, recipient email addresses, and the message body text which may be incorrect in actual use.

This updated version addresses those potential problems, no pun intended.

<b>Attached File Mimetype</b>

Instead of assuming <tt>application/octet-stream</tt>, we can use the python-magic module (available <a href="http://pypi.python.org/pypi/python-magic/0.3.1" target="_blank">here</a>, <a href="http://github.com/ahupp/python-magic" target="_blank">here</a>, or by <tt>apt-get install python-magic</tt> on <a href="http://www.debian.org/" target="_blank">Debian</a> and <a href="http://www.ubuntu.com/" target="_blank">Ubuntu</a> systems) to determine it explicitly:

<pre>
MIME_MAGIC = None
try:
    import magic
    MIME_MAGIC = magic.open(magic.MAGIC_MIME)
    MIME_MAGIC.load()
except ImportError:
    pass
    
def get_file_mimetype (filename):
    """Return the mimetype string for this file"""
    result = None
    if MIME_MAGIC:
        try:
            result = MIME_MAGIC.file(filename)
        except (IOError):
            pass
    return result
</pre>

The get_file_mimetype() function returns a string in the form <tt>'Content-Type major type/Content-Type minor type'</tt>, e.g. <tt>'text/plain charset=us-ascii'</tt>, <tt>'application/pdf'</tt>, etc.

Now we can change the loop that attaches files to the message from this:

<pre>
    for file in files:
        part = MIMEBase('application', "octet-stream")
        part.set_payload( open(file,"rb").read() )
        Encoders.encode_base64(part)
        part.add_header('Content-Disposition', 'attachment; filename="%s"'
                       % os.path.basename(file))
        msg.attach(part)
</pre>

To this, below. Note that since the mimetype can be text, we change the file read flag from "rb" (binary) to just "r", as necessary.

<pre>
    for file in files:
 
        file_read_flags = "rb"
        try:
            mimestring = get_file_mimetype(file)
            if mimestring.startswith('text'):
                file_read_flags = "r"
            mimestring_parts = mimestring.split('/')
            part = MIMEBase(mimestring_parts[0], mimestring_parts[1])
        except AttributeError, IndexError:
            # cannot determine the mimetype so use the generic 'application/octet-stream'
            part = MIMEBase('application', 'octet-stream')

        part.set_payload( open(file, file_read_flags).read() )
        Encoders.encode_base64(part)
        part.add_header('Content-Disposition', 'attachment; filename="%s"'
                       % os.path.basename(file))
        msg.attach(part)
</pre>

<b>Subject Encoding</b>

The original version used a simple assignment to define the Subject line:

<pre>
    msg['Subject'] = subject
</pre>

But this limits the Subject line to 7-bit ASCII characters only. For foreign language support and other encodings, it's better to use the <tt>email.Header</tt> package, which requires an additional import:

<pre>
from email.Header import Header
</pre>

The Subject line assignment changes to:

<pre>
    # always pass Unicode strings to Header, otherwise it will use RFC 2047 encoding even on plain ASCII strings
    msg['Subject'] = Header(to_unicode(subject), 'iso-8859-1') 
</pre>

Where the to_unicode() function is defined as:

<pre>
def to_unicode (s):
    """Convert the given byte string to unicode, using the standard encoding,
    unless it's already encoded that way"""
    if s:
        if isinstance(s, unicode):
            return s
        else:
            return unicode(s, 'utf-8')
</pre>

<b>Email Address Encoding</b>

Unlike the Subject line, all email addresses must be ascii, so instead of defining the recipient list like this:

<pre>
    msg['To'] = COMMASPACE.join(to)
</pre>

We should map an explicit ascii encoding function over each email address, like this:

<pre>
    msg['To'] = COMMASPACE.join(map(lambda x: x.encode('ascii'), to)) 
</pre>

<b>Body Text Encoding</b>

Finally, the message body text, regardless of whether or not it's plain text, html, or both, must be unicode. So we go from this:

<pre>
    msg.attach( MIMEText(text) )
</pre>

To this:

<pre>
    msg.attach(MIMEText(to_bytestring(text), 'plain', 'utf-8'))
</pre>

If we want an html message body, we would do this:

<pre>
    msg.attach(MIMEText(to_bytestring(html_text), 'html', 'utf-8'))
</pre>

Actually, if you are going to use html in email messages at all, the best practice is to provide both a plain text and an html equivalent together, like this:

<pre>
    msg.attach(MIMEText(to_bytestring(text), 'plain', 'utf-8'))
    msg.attach(MIMEText(to_bytestring(html_text), 'html', 'utf-8'))
</pre>

In all the examples above, the to_bytestring() function is defined as:

<pre>
def to_bytestring (s):
    """Convert the given unicode string to a bytestring, using the standard encoding,
    unless it's already a bytestring"""
    if s:
        if isinstance(s, str):
            return s
        else:
            return s.encode('utf-8')
</pre>

<b>A Complete Example</b>

Putting it all together, this function lets you send the same email to multiple recipients, with optional files (binary or text) as attachments, and an optional message body in html.

It also allows you to define the "Reply-To" header of the message as a email address different from the one used to send the message.

<pre>
def send(sender, subject, recipient_list=[], text, html=None, files=[], replyto=None):
    """Send a message to the given recipient list, with the optionally attached files"""
    msg = MIMEMultipart('alternative')
    msg['From'] = sender.encode('ascii') 
    # make sure email addresses do not contain non-ASCII characters
    msg['To'] = COMMASPACE.join(map(lambda x: x.encode('ascii'), recipient_list)) 
    if replyto:
        # make sure email addresses do not contain non-ASCII characters
        msg['Reply-To'] = replyto.encode('ascii') 
    msg['Date'] = formatdate(localtime=True)

    # always pass Unicode strings to Header, otherwise it will use RFC 2047 encoding even on plain ASCII strings
    msg['Subject'] = Header(to_unicode(subject), 'iso-8859-1') 

    # always use Unicode for the body text, both plain and html content types
    msg.attach(MIMEText(to_bytestring(text), 'plain', 'utf-8'))
    if html:
        msg.attach(MIMEText(to_bytestring(html), 'html', 'utf-8'))

    for file in files:
 
        file_read_flags = "rb"
        try:
            mimestring = get_file_mimetype(file)
            if mimestring.startswith('text'):
                file_read_flags = "r"
            mimestring_parts = mimestring.split('/')
            part = MIMEBase(mimestring_parts[0], mimestring_parts[1])
        except AttributeError, IndexError:
            # cannot determine the mimetype so use the generic 'application/octet-stream'
            part = MIMEBase('application', 'octet-stream')

        part.set_payload( open(file, file_read_flags).read() )
        Encoders.encode_base64(part)
        part.add_header('Content-Disposition', 'attachment; filename="%s"'
                       % os.path.basename(file))
        msg.attach(part)

    smtp = smtplib.SMTP(mail_server)
    smtp.sendmail(sender, recipient_list, msg.as_string() )
    smtp.close()
</pre>
        <hr>
      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
	<a name="contacts"></a>
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <ul class="list-inline text-center">
	    <li>
	      <a href="mailto:denis@papathanasiou.org">
		<span class="fa-stack fa-lg">
		  <i class="fa fa-circle fa-stack-2x"></i>
		  <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
		</span>
	      </a>
	    </li>
	    <li>
	      <a href="https://github.com/dpapathanasiou">
		<span class="fa-stack fa-lg">
		  <i class="fa fa-circle fa-stack-2x"></i>
		  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
		</span>
	      </a>
	    </li>
	  </ul>
	</div>
      </div>
      <div class="row">
	<a name="license"></a>
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <p class="copyright text-muted">
	    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> &nbsp;
	    This site's content is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons (BY-NC-SA 4.0)</a>
	  </p>
	</div>
      </div>
    </div>
  </footer>

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="../js/my-blog.min.js"></script>
  
</body>
</html>


