<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=" | The personal web site of Denis Papathanasiou">
    <meta name="author" content="Denis Papathanasiou">
    <title>DSL processing in Scala</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link href="../css/my-blog.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

  <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>
  <nav id="sidebar-wrapper">
    <ul class="sidebar-nav">
      <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
      <li class="sidebar-brand"><a href="../" onclick="$('#menu-close').click();" >Denis Papathanasiou</a></li>
      <li class="sidebar-brand"><a href="../aikido.html" onclick="$('#menu-close').click();" >aikido</a></li>
      <li class="sidebar-brand"><a href="../hardware.html" onclick="$('#menu-close').click();" >hardware</a></li>
      <li class="sidebar-brand"><a href="../programming.html" onclick="$('#menu-close').click();" >programming</a></li>
      <li class="sidebar-brand"><a href="../random.html" onclick="$('#menu-close').click();" >random</a></li>
      <li class="sidebar-brand"><a href="../technology.html" onclick="$('#menu-close').click();" >technology</a></li>
      <li class="sidebar-brand"><a href="../#contacts" onclick="$('#menu-close').click();" >contact</a></li>
    </ul>
  </nav>


  <header class="intro-header" style="background-image: url('/img/source-code-bg.jpg')"> <!-- source: https://pixabay.com/en/source-code-code-programming-c-583537/ -->
    <div class="container">
      <div class="row">
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <div class="site-heading" style="color:#00ff00">
	    <h1>DSL processing in Scala</h1>
	    <hr class="small">
	    <h2 class="subheading"></h2>
	    <p class="post-meta"><i class="fa fa-calendar"></i> July 26, 2015</p>

	  </div>
	</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<p>I was recently presenting with the following programming puzzle, which I decided to try to solve in <a href="http://www.scala-lang.org/" target="_blank">scala</a> (scala is still very new to me, so I took it as a challenge to help my learning):</p>
<blockquote>Start with an empty matrix (two-dimensional array) sized N by N with all cells set to zero.
<p>Simulate population growth in a given range of cells by adding, multiplying, or raising to a power the current cell population by a given factor.</p>
<p>Those instructions come in the form:</p>
<ul>
<li><tt>x1:x2;y1:y2;+i</tt> : add i to the current population in each cell defined by matrix(x, y) where x1 &lt; = x &lt;= x2 and y1 &lt;= y &lt;= y2</li>
<li><tt>x1:x2;y1:y2;*m</tt> : multiply the current population in each cell by m</li>
<li><tt>x1:x2;y1:y2;^n</tt> : raise the current population in each cell by a power of n</li>
</ul>
<p>The entire simulation instruction takes the form of a single space separated string. The very first part is an integer, specifying the size of the matrix, and the rest of the string is one or more growth instructions also separated by spaces.</p>
<p>Here&#8217;s an example:</p>
<p><tt>"10 1:2;2:3;+1 2:2;3:3;+5 7:9;5:8;^3"</tt></p>
<p>The program should take the sum of all the cells in the matrix after all the growth instructions have been processed.</p>
<p>For the example above, the expected answer is 9.</p></blockquote>
<p>I started by defining <a href="http://www.cs.tut.fi/~jkorpela/perl/regexp.html" target="_blank">regular expression</a> patterns for the expected inputs.</p>
<p>This describes the overall instruction string in two parts, the initial integer for the matrix size, along with the rest of the growth instructions:</p>
<pre>val argsPattern = """^(\d+)\s(.*)""".r
</pre>
<p>Inside a main() method, it can be used like this:</p>
<pre>args(0) match {
  case argsPattern (n, rest) =&gt; println(getPopulation(setPopulation(n.toInt, rest.split(" "))))
  case _ =&gt; println("Invalid input")
}
</pre>
<p>Even though scala has elegant exception handling in the form of <a href="http://danielwestheide.com/blog/2012/12/19/the-neophytes-guide-to-scala-part-5-the-option-type.html" target="_blank">Option/Some</a> and <a href="http://danielwestheide.com/blog/2012/12/26/the-neophytes-guide-to-scala-part-6-error-handling-with-try.html" target="_blank">Try/Success/Failure</a> constructs, we can go ahead and do <tt>n.toInt</tt> confidently because that branch of the match statement won&#8217;t get executed unless there is a leading number in the given string.</p>
<p>Next, we need a regex for the possible growth instructions. This one covers all three cases:</p>
<pre>val inputPattern = """(\d+:\d+);(\d+:\d+);((\^|\+|\*)\d+)""".r
</pre>
<p>While inputPattern can tell us whether or not a given string is a valid growth instruction, we should have separate functions to handle the different types of mathematical operations.</p>
<p>Since functions can be passed as first-class objects in scala, we&#8217;ll use these three <a href="https://en.wikipedia.org/wiki/Currying" target="_blank">curried functions</a>, where b is the value found in the instruction string, and a represents the current cell population, input at runtime:</p>
<pre>def popPlus (b: Long)(a: Long): Long = a + b
def popRaise (b: Long)(a: Long): Long = scala.math.pow(a, b).toLong
def popMultiply (b: Long)(a: Long): Long = a * b
</pre>
<p>Now, we should write inputPattern as a separate series for each case:</p>
<pre>val plusPattern = """^(\+)(\d+)""".r
val multiplyPattern = """^(\*)(\d+)""".r
val raisePattern = """^(\^)(\d+)""".r
</pre>
<p>That enables us to write match statements like this:</p>
<pre>s match {
  case plusPattern(sign, value) =&gt; popPlus(value.toLong)
  case multiplyPattern(sign, value) =&gt; popMultiply(value.toLong)
  case raisePattern(sign, value) =&gt; popRaise(value.toLong)
  case _ =&gt; {
    println("Invalid increment pattern: %s".format(s)) // side effect (we could do without, but useful perhaps for feedback)
    popPlus(0) // an invalid pattern does not change the matrix
  }
}
</pre>
<p>A valid match results in a partially-evaluated function, using the given string value as +value, *value, or ^value.</p>
<p>Again, since the string has matched the regex at this point, we can just go ahead and do the <tt>value.toLong</tt> conversion, knowing it won&#8217;t fail.</p>
<p>The other part of interpreting the growth instruction is determining the range of x and y cell values. For each pair of integers separated by colons in the x or y direction, we can write a simple function to take a string in the form <tt>"n:m"</tt> and return an array of integers from n to m+1 like this:</p>
<pre>def parseInputRange (s: String): Array[Int] = {
  val ab = s.split(":").map(_.toInt)
  (ab(0) until ab(1)+1).toArray
}
</pre>
<p>As with all the other string to number conversions, we can do the without worry, since this function will be called only if the regex matches.</p>
<p>It&#8217;s a huge simplification from having to do <tt>Try {} except {}</tt> in every numeric conversion.</p>
<p>We also need functions to create the matrix, and another to scan each cell and take a sum. Those tasks are handled by these next two functions:</p>
<pre>def createMatrix(n: Int): Array[Array[Long]] =
  Array.ofDim[Long](n, n)
</pre>
<pre>def getPopulation (matrix: Array[Array[Long]]): Long = {
  for {
    row   0)
  } yield cell
}.sum
</pre>
<p>In getPopulation we remove all the cells whose population stayed at zero, and take of sum of just what remains.</p>
<p>Finally, we need something to create the matrix, and cycle through all the growth instructions.</p>
<p>While it&#8217;s simple enough to do it as an iteration, updating (mutating) the same matrix over and over again, here&#8217;s a pure functional recursive solution:</p>
<pre>def setPopulation (n: Int, inputs: Array[String]): Array[Array[Long]] = {
  @annotation.tailrec
  def calculate(m: Array[Array[Long]], inp: Array[String]): Array[Array[Long]] = {
    if( 0 == inp.length ) m
    else calculate(processInput(inp(0), m), inp.tail)
  }
  calculate(createMatrix(n), inputs)
}
</pre>
<p>The <a href="https://gist.github.com/dpapathanasiou/b9d85685a0381f1deea0" target="_blank">full source code</a> is here: <a href="https://gist.github.com/dpapathanasiou/b9d85685a0381f1deea0" target="_blank">https://gist.github.com/dpapathanasiou/b9d85685a0381f1deea0</a></p>

        <hr>
      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
	<a name="contacts"></a>
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <ul class="list-inline text-center">
	    <li>
	      <a href="mailto:denis@papathanasiou.org">
		<span class="fa-stack fa-lg">
		  <i class="fa fa-circle fa-stack-2x"></i>
		  <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
		</span>
	      </a>
	    </li>
	    <li>
	      <a href="https://github.com/dpapathanasiou">
		<span class="fa-stack fa-lg">
		  <i class="fa fa-circle fa-stack-2x"></i>
		  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
		</span>
	      </a>
	    </li>
	  </ul>
	</div>
      </div>
      <div class="row">
	<a name="license"></a>
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <p class="copyright text-muted">
	    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> &nbsp;
	    This site's content is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons (BY-NC-SA 4.0)</a>
	  </p>
	</div>
      </div>
    </div>
  </footer>

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="../js/my-blog.min.js"></script>
  
</body>
</html>


