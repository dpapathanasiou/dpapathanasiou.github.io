<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=" | The personal web site of Denis Papathanasiou">
    <meta name="author" content="Denis Papathanasiou">
    <title>Node.js and MongoDB: A Simple Example</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link href="../css/my-blog.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

  <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>
  <nav id="sidebar-wrapper">
    <ul class="sidebar-nav">
      <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
      <li class="sidebar-brand"><a href="../" onclick="$('#menu-close').click();" >Denis Papathanasiou</a></li>
      <li class="sidebar-brand"><a href="../aikido.html" onclick="$('#menu-close').click();" >aikido</a></li>
      <li class="sidebar-brand"><a href="../hardware.html" onclick="$('#menu-close').click();" >hardware</a></li>
      <li class="sidebar-brand"><a href="../programming.html" onclick="$('#menu-close').click();" >programming</a></li>
      <li class="sidebar-brand"><a href="../random.html" onclick="$('#menu-close').click();" >random</a></li>
      <li class="sidebar-brand"><a href="../technology.html" onclick="$('#menu-close').click();" >technology</a></li>
      <li class="sidebar-brand"><a href="../#contacts" onclick="$('#menu-close').click();" >contact</a></li>
    </ul>
  </nav>


  <header class="intro-header" style="background-image: url('/img/source-code-bg.jpg')"> <!-- source: https://pixabay.com/en/source-code-code-programming-c-583537/ -->
    <div class="container">
      <div class="row">
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <div class="site-heading" style="color:#00ff00">
	    <h1>Node.js and MongoDB: A Simple Example</h1>
	    <hr class="small">
	    <h2 class="subheading"></h2>
	    <p class="post-meta"><i class="fa fa-calendar"></i> September 22, 2011</p>

	  </div>
	</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<strong>Update</strong>, October 14, 2012:<br />
If you are interested in creating highly scalable applications with mongoDB, you should really consider using <a href="http://golang.org/" target="_blank">Go (#golang)</a> instead, and check out the <a href="http://denis.papathanasiou.org/?p=1090" target="_blank">Go version of this post</a>.<hr />

I've been learning <a href="http://nodejs.org/" target="_blank">Node.js</a>. After getting through an excellent <a href="http://nodebeginner.org/index.html" target="_blank">basic tutorial</a>, I wanted to experiment with connecting to <a href="http://mongodb.org/" target="_blank">MongoDB</a>, since it would be helpful for some enhancements I have planned for <a href="http://stealthmodewatch.com/" target="_blank">Stealth Mode Watch</a> and <a href="http://bookhunch.com/" target="_blank">BookHunch</a>.

There are <a href="http://www.mongodb.org/display/DOCS/node.JS" target="_blank">several drivers available</a>, but the most commonly used and recommended one is <a href="https://github.com/christkv/node-mongodb-native" target="_blank">node-mongodb-native</a>.

Despite the <a href="https://github.com/christkv/node-mongodb-native/tree/master/examples" target="_blank">examples</a>, though, it wasn't clear how to collect and return the results of a single query.

Both the <a href="https://github.com/christkv/node-mongodb-native/blob/master/examples/simple.js" target="_blank">simple example</a> and the <a href="https://github.com/christkv/node-mongodb-native/blob/master/examples/queries.js" target="_blank">queries example</a> just dump the result to the console within the cursor, and the <a href="http://stackoverflow.com/questions/4789045/how-can-i-set-up-mongodb-on-a-node-js-server-using-node-mongodb-native-in-an-ec2/4831463#4831463" target="_blank">best answer</a> on the normally reliable <a href="http://stackoverflow.com/" target="_blank">StackOverflow</a> site was problematic, too, because the server code was written in a blocking style without callbacks, which <a href="http://nodebeginner.org/index.html#head24" target="_blank">defeats the purpose of using Node.js</a> in the first place.

Fortunately, though, there is a <a href="http://howtonode.org/control-flow" target="_blank">terrific article about control flow</a> on <a href="http://howtonode.org/" target="_blank">How to Node</a> which explains how to do multiple asynchronous tasks (either in parallel or serially), and collect all the results.

The examples in the control flow article dealt with accessing files from different folders, which was simple enough to change to running MongoDB queries instead.

The first step is to install node-mongodb-native using <a href="http://howtonode.org/introduction-to-npm" target=_"blank">npm</a>:<blockquote>npm config set loglevel info
npm install mongodb </blockquote>

The first line essentially sets npm in a verbose mode, to let you know what it's doing as it runs (a tip from the guys at <a href="http://nodejitsu.com/" target="_blank">Nodejitsu.com</a>), and the second actually installs the node-mongodb-native module (it seems that the native parser is obsolete, so there is no need to use the <tt>--mongodb:native</tt> switch in the second line).

Here's how to execute multiple queries and collect their results.

<pre>var Db = require('./node_modules/mongodb').Db,
    Connection = require('./node_modules/mongodb').Connection,
    Server = require('./node_modules/mongodb').Server;

var host = process.env['MONGO_NODE_DRIVER_HOST'] != null ? 
           process.env['MONGO_NODE_DRIVER_HOST'] : 'localhost';
var port = process.env['MONGO_NODE_DRIVER_PORT'] != null ?
           process.env['MONGO_NODE_DRIVER_PORT'] : Connection.DEFAULT_PORT;</pre>

These lines just load the db module and prepare for a connection; no connection has been opened yet.

This function executes the query in the db, collects the result documents in a list, and passes them to a callback function when it's done iterating through the query cursor:

<pre>function runQuery (db, myCollection query, nextFn) {
    // perform the {query} on the collection and invoke the nextFn when done
    db.open(function(err, db) {
	db.collection(myCollection, function(err, collection) {
	    collection.find(query, function(err, cursor) {
		cursor.toArray(function(err, docs) {
		    console.log("Found " + docs.length + " documents");
		    var queryResults = [];
		    for(var i=0; i&lt;docs.length; i++) {
			queryResults[queryResults.length] = docs[i]; 
		    }
		    db.close();
		    nextFn(queryResults);
		});
	    });
	});
    });
}</pre>

So that leaves opening the connection, defining the query or queries, and calling runQuery().

Suppose we have a database consisting of two collections, people and companies, and that we want to search for a given string anywhere among a person's name, a company's name, or even a company's address.

Our search function would look like this:

<pre>function search (personName, companyName, address, nextFn) {
    var data = [], count = 3;
    var doneFn = function(results) {
	data = data.concat(results);
	count--;
	if( count &lt;= 0 ) {
	    var uniqueResults = [];
	    for(var i=0; i&lt;data.length; i++) {
		if( ! uniqueResults[data[i]['_id']] ) {
		    uniqueResults[uniqueResults.length] = data[i];
		    uniqueResults[data[i]['_id']] = true;
		}
	    }
	    nextFn(uniqueResults);
	}
    };
    runQuery(new Db('mydb', new Server(host, port, {})),
	     'people',
	     {'name':new RegExp('^'+personName, 'i')},
	     doneFn);
    runQuery(new Db('mydb', new Server(host, port, {})),
	     'companies',
	     {'name':new RegExp('^'+companyName, 'i')},
	     doneFn);
    runQuery(new Db('mydb', new Server(host, port, {})),
	     'companies',
	     {'address':new RegExp(address, 'i')},
	     doneFn);
}</pre>

Just like the control flow article, we use a counter in our callback function -- doneFn -- to check when there are no more queries to run, and once that's the case, we iterate through the combined list of results and use the document ObjectId to ensure the list of results is unique.

That unique list of results is then passed to the callback function given to search(), i.e., nextFn, which ultimately decides what to do with the combined results.

Each call to runQuery() needs its own db connection, opened like this:

<tt>new Db('mydb', new Server(host, port, {}))</tt>

because each query will run asynchronously and independently of each other.

It's also possible to define a single connection, once, before each of the runQuery() calls happen:

<tt>var db = new Db('mydb', new Server(host, port, {}));</tt>

and just pass the db variable to runQuery(), but then the <tt>db.close()</tt> line would have to be removed from inside the runQuery() function, and placed inside the doneFn instead.

As for the queries themselves, the beautiful thing about using Javascript and MongoDB together is that any native Javascript object doubles as the query input to MongoDB.

So any query that works in the MongoDB command line, will work in Javascript without much or any transformation necessary, unlike the <a href="http://stackoverflow.com/questions/3483318/performing-regex-queries-with-pymongo/3483399#3483399" target="_blank">hoops you have</a> to <a href="http://alexbraunstein.com/2011/06/07/pymongo-distinct-items-and-an-example-map-reduce-on-subset-of-db/" target="_blank">jump through in Python+pymongo</a>.

Finally, the function that calls search() has to decide what to do with the results.

If we're writing an API and want the results sent back over HTTP as json, all we have to do is this (within the larger context of an http server in Node.js, of course):

<pre>apiSearch('Jones', 'Jones', 'California', function(results) {
    var replyJson = {"warning":"No matches found"};
    if( results.length > 0 ) {
	replyJson = {"result":{ "matched":results.length, "matches":results}};
    }
    response.writeHead(200, {"Content-Type": "application/json"});
    response.write(JSON.stringify(replyJson));
    response.end();
});</pre>

This example searches the database for people or companies named Jones, or companies located in California.

The final callback here gets passed the unique list of results from the search.doneFn -- i.e., it is the nextFn passed into search() -- and generates an http response in json format.
<p>&nbsp;</p>
        <hr>
      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
	<a name="contacts"></a>
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <ul class="list-inline text-center">
	    <li>
	      <a href="mailto:denis@papathanasiou.org">
		<span class="fa-stack fa-lg">
		  <i class="fa fa-circle fa-stack-2x"></i>
		  <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
		</span>
	      </a>
	    </li>
	    <li>
	      <a href="https://github.com/dpapathanasiou">
		<span class="fa-stack fa-lg">
		  <i class="fa fa-circle fa-stack-2x"></i>
		  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
		</span>
	      </a>
	    </li>
	  </ul>
	</div>
      </div>
      <div class="row">
	<a name="license"></a>
	<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <p class="copyright text-muted">
	    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> &nbsp;
	    This site's content is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons (BY-NC-SA 4.0)</a>
	  </p>
	</div>
      </div>
    </div>
  </footer>

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="../js/my-blog.min.js"></script>
  
</body>
</html>


